<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
      body { background-color: #111; color: #f8f9fa; }
      .navbar, footer { background-color: #000; }
      .hero {
        background: url("/img/parallax.jpg") center/cover no-repeat fixed;
        height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        color: #ffffffe7;
        text-shadow: 2px 2px 5px black;
      }
    </style>
  </head>
<body>

  <%- include('partials/navbar') %>

  <main class="container my-4">
    <h2 class="mb-4">Resultados para "<%= termo %>"</h2>

    <% if (medicamentos.length === 0) { %>
      <p class="text-muted">Nenhum medicamento encontrado.</p>
    <% } else { %>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        <% medicamentos.forEach(med => { %>
          <div class="col">
            <div class="card h-100 shadow-sm d-flex flex-column">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title"><%= med.nome %></h5>

                <!-- ✅ Linha corrigida -->
                <p class="card-text text-muted">
                  R$ <%= Number(med.preco).toFixed(2) %>
                </p>

                <p class="card-text flex-grow-1"><%= med.descricao || 'Sem descrição' %></p>

                <div class="d-flex align-items-center justify-content-center mb-3" style="height:180px; overflow:hidden;">
                  <img src="<%= med.imagem %>" alt="<%= med.nome %>" class="img-fluid" style="max-height:100%; object-fit:contain;">
                </div>

                <div class="mt-auto d-flex gap-2">
                  <button class="btn btn-success flex-fill add-cart"
                          data-id="<%= med._id %>" 
                          data-nome="<%= med.nome %>" 
                          data-preco="<%= med.preco %>">+</button>
                  <button class="btn btn-danger flex-fill remove-cart"
                          data-id="<%= med._id %>">−</button>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

    <div class="mt-3 d-flex gap-2">
      <a href="/carrinho" class="btn btn-outline-primary">Ir para o carrinho</a>
      <a href="/" class="btn btn-outline-secondary">← Voltar para o início</a>
    </div>
  </main>

  <script>
    async function addToCart(id, nome, preco) {
      try {
        await fetch('/carrinho/adicionar', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ medicamentoId: id, nome, preco })
        });
        updateCartCount();
      } catch (err) { console.error(err); }
    }

    async function removeFromCart(id) {
      try {
        await fetch('/carrinho/remover', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ medicamentoId: id })
        });
        updateCartCount();
      } catch (err) { console.error(err); }
    }

    async function updateCartCount() {
      try {
        const res = await fetch('/carrinho/count');
        const data = await res.json();
        const badge = document.querySelector('#cart-count');
        if (badge) badge.textContent = data.count;
      } catch (err) { console.error(err); }
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateCartCount();

      document.querySelectorAll('.add-cart').forEach(btn => {
        btn.addEventListener('click', () => {
          addToCart(btn.dataset.id, btn.dataset.nome, parseFloat(btn.dataset.preco));
        });
      });

      document.querySelectorAll('.remove-cart').forEach(btn => {
        btn.addEventListener('click', () => {
          removeFromCart(btn.dataset.id);
        });
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <%- include('partials/footer') %>
</body>
</html>
